@using Blazored.Modal
@using Blazored.Modal.Services;
@using CBCanteen.Client.ComponentLibrary.Components
@using CBCanteen.Client.Services.Contracts;
@using CBCanteen.Shared.Models.Canteen.DailyOrder;
@using CBCanteen.Shared.Models.Canteen.MealOrder;
@using CBCanteen.Shared.Models.Canteen.Menu;
@using CBCanteen.Shared.Models.Canteen.MenuOrder;
@using CBCanteen.Shared.Models.ReflectionHelpers;
@using Syncfusion.Blazor.Grids
@using CBCanteen.Shared.Models.Canteen.Meal
@using Plk.Blazor.DragDrop
@using System.Collections.ObjectModel;

@inject IMealService mealService
@inject IMenuService menuService
@inject IDailyOrderService dailyOrderService
@inject IMenuOrderService menuOrderService
@inject IMealOrderService mealOrderService

<div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all w-full sm:my-8 sm:align-middle">
    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
        <h3 class="text-lg leading-6 font-medium text-gray-900 text" id="modal-title">
            Обяд за @(MenuDate.ToString("d MMM yyyy"))
        </h3>
        <div class="mt-4 flex w-full space-x-4">
           <div class="w-full">
                <p class="text-center text-xl text mb-4">Пакетни менюта</p>
                <div class="flex h-40 justify-between border-2 rounded-lg border-[#94A3B8]">
                    <div class="flex flex-row">
                        <div class="h-full items-center justify-center flex mr-6 ml-6">
                            <input type="checkbox" disabled=@isPast @bind=@MenuOneCheckboxValue />
                        </div>
                        <div class="flex flex-col">
                            <p class="font-bold text-2xl text mt-1 mb-1">Ястия</p>
                            @if (dailyOrder is not null)
                            {
                                <p class="text text-xl">1. @dailyOrder.MenuOne.Appetizer.Name</p>
                                <p class="text text-xl">2. @dailyOrder.MenuOne.MainDish.Name</p>
                                <p class="text text-xl">3. @dailyOrder.MenuOne.Dessert.Name</p>
                                <p class="text text-xl">4. Хляб - 2 филии</p>
                            }
                        </div>
                    </div>
                    <div class="flex flex-col items-stretch mr-6">
                        <div>
                            <p class="font-bold text-2xl text mt-1 mb-1">Цена</p>
                            @if (dailyOrder is not null)
                            {
                                <p class="text text-xl">@dailyOrder.MenuOne.Price лв.</p>
                            }
                        </div>
                        <div>
                            <p class="font-bold text-2xl text mt-1 mb-1">Брой</p>
                            <input type="number" class="w-16 border-2 border-[#94A3B8] rounded-lg text-center" disabled=@isPast @bind=@MenuOneQuantity />
                        </div>
                    </div>
                </div>
                <div class="flex h-40 justify-between border-2 rounded-lg border-[#94A3B8] mt-6">
                    <div class="flex flex-row">
                        <div class="h-full items-center justify-center flex mr-6 ml-6">
                            <input type="checkbox" disabled=@isPast @bind=@MenuTwoCheckboxValue />
                        </div>
                        <div class="flex flex-col">
                            <p class="font-bold text-2xl text mt-1 mb-1">Ястия</p>
                            @if (dailyOrder is not null)
                            {
                                <p class="text text-xl">1. @dailyOrder.MenuTwo.Appetizer.Name</p>
                                <p class="text text-xl">2. @dailyOrder.MenuTwo.MainDish.Name</p>
                                <p class="text text-xl">3. @dailyOrder.MenuTwo.Dessert.Name</p>
                                <p class="text text-xl">4. Хляб - 2 филии</p>
                            }
                        </div>
                    </div>
                    <div class="flex flex-col items-stretch mr-6">
                        <div>
                            <p class="font-bold text-2xl text mt-1 mb-1">Цена</p>
                            @if (dailyOrder is not null)
                            {
                                <p class="text text-xl">@dailyOrder.MenuTwo.Price лв.</p>
                            }
                        </div>
                        <div>
                            <p class="font-bold text-2xl text mt-1 mb-1">Брой</p>
                            <input type="number" class="w-16 border-2 border-[#94A3B8] rounded-lg text-center" disabled=@isPast @bind=@MenuTwoQuantity />
                        </div>
                    </div>
                </div>
           </div>
           <div class="w-full">
                <p class="text-center text-xl text mb-4">Свободна консумация</p>
                <div class="flex justify-between">
                    <div class="flex space-x-4">
                        <input type="checkbox" class="invisible" />
                        <p class="font-bold text-2xl text mt-1 mb-1">Ястие</p>
                    </div>
                    <div class="flex space-x-4">
                        <p class="font-bold text-2xl text mt-1 mb-1">Цена</p>
                        <p class="font-bold text-2xl text mt-1 mb-1">Брой</p>
                    </div>
                </div>
                @if (dailyOrder is not null)
                {
                    @foreach (var meal in dailyOrder.FreeConsumption)
                    {
                        <div class="flex justify-between border-2 border-[#94A3B8] rounded-lg p-1 mb-2">
                            <div class="flex space-x-2">
                                <input type="checkbox" @bind=@meal.IsChecked />
                                <p>@meal.Name</p>
                            </div>
                            <div class="flex space-x-2">
                                <p>@meal.UnitPrice лв.</p>
                                <input type="number" class="w-16 border-2 border-[#94A3B8] rounded-lg text-center" @bind=@meal.Quantity />
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
    <div class="py-3 px-6 flex flex-row-reverse">
        @if (!isPast)
        {
            <GreenButton Text=@(isUpdate ? "Промени" : "Добави") StyleClass="ml-2 py-1 px-3" OnClickCallback=@(isUpdate ? UpdateOrder : PlaceOrder) />
        }
        <GrayButton Text="Откажи" StyleClass="py-1 px-3" OnClickCallback="CloseModal" />
    </div>
</div>

@code {
    private ObservableCollection<MealVM> MenuOneMeals = new();

    private ObservableCollection<MealVM> MenuTwoMeals = new();

    private ObservableCollection<MealVM> FreeConsumptionMeals = new();

    private List<MenuOrderVM> MenuOrders = new();

    private List<MealOrderVM> MealOrders = new();

    private bool MenuOneCheckboxValue = false;

    private int MenuOneQuantity = 0;

    private bool MenuTwoCheckboxValue = false;

    private int MenuTwoQuantity = 0;

    [Parameter]
    public DateTime MenuDate { get; set; }

    [CascadingParameter]
    private BlazoredModalInstance BlazoredModal { get; set; } = default!;

    [CascadingParameter]
    private IModalService Modal { get; set; } = default!;

    private bool isUpdate = false;
    private bool isPast = false;

    private DailyOrderVM dailyOrder;

    protected async override Task OnInitializedAsync()
    {
        var dailyOrders = await this.dailyOrderService.GetDailyOrderAsync(this.MenuDate.Date, this.MenuDate.Date.AddHours(23));

        dailyOrder = dailyOrders.FirstOrDefault();

        var menuOrders = await this.menuOrderService.GetMenuOrderAsync(this.MenuDate.Date, this.MenuDate.Date.AddHours(23));
        var mealOrders = await this.mealOrderService.GetMealOrderAsync(this.MenuDate.Date, this.MenuDate.Date.AddHours(23));

        this.MealOrders = mealOrders;
        this.MenuOrders = menuOrders;

        if (mealOrders.Count > 0 || menuOrders.Count > 0)
        {
            isUpdate = true;
        }

        if (this.MenuDate.Date < DateTime.Now.Date)
        {
            isPast = true;
        }

        this.MenuOneMeals = new(menuService.GetMealsFromMenuAsync(dailyOrder!.MenuOne));
        this.MenuTwoMeals = new(menuService.GetMealsFromMenuAsync(dailyOrder.MenuTwo));
        this.FreeConsumptionMeals = new(dailyOrder.FreeConsumption);


        foreach (var menu in menuOrders)
        {
            if (menu.Menu.Id == dailyOrder.MenuOne.Id)
            {
                MenuOneCheckboxValue = true;
                MenuOneQuantity = menu.Quantity;
            }
            else if (menu.Menu.Id == dailyOrder.MenuTwo.Id)
            {
                MenuTwoCheckboxValue = true;
                MenuTwoQuantity = menu.Quantity;
            }
        }

        foreach (var meal in mealOrders)
        {
            if (FreeConsumptionMeals.Select(fc => fc.Id).Contains(meal.Meal.Id))
            {
                FreeConsumptionMeals.First(fc => fc.Id == meal.Meal.Id).Quantity = meal.Quantity;
                FreeConsumptionMeals.First(fc => fc.Id == meal.Meal.Id).IsChecked = true;
            }
        }
    }

    /// <summary>
    /// Create daily menu
    /// </summary>
    private async Task PlaceOrder()
    {
        if (FreeConsumptionMeals.Select(fc => fc.IsChecked).All(el => (el == false)) && !MenuOneCheckboxValue && !MenuTwoCheckboxValue)
        {
            return;
        }

        foreach (var meal in FreeConsumptionMeals)
        {
            if (meal.IsChecked && meal.Quantity <= 0)
            {
                return;
            }
        }

        if (MenuOneCheckboxValue && MenuOneQuantity <= 0)
        {
            return;
        }

        if (MenuTwoCheckboxValue && MenuTwoQuantity <= 0)
        {
            return;
        }

        if (MenuOneCheckboxValue)
        {
            var menuOrderIM = new MenuOrderIM()
                {
                    MenuId = dailyOrder.MenuOne.Id,
                    Quantity = MenuOneQuantity,
                    Date = this.MenuDate.Date
                };

            await this.menuOrderService.CreateMenuOrderAsync(menuOrderIM);
        }

        if (MenuTwoCheckboxValue)
        {
            var menuTwoIm = new MenuOrderIM()
                {
                    MenuId = dailyOrder.MenuTwo.Id,
                    Quantity = MenuTwoQuantity,
                    Date = this.MenuDate.Date
                };

            await this.menuOrderService.CreateMenuOrderAsync(menuTwoIm);
        }

        foreach (var meals in FreeConsumptionMeals)
        {
            if (meals.IsChecked)
            {
                var mealOrderIM = new MealOrderIM()
                    {
                        MealId = meals.Id,
                        Quantity = meals.Quantity,
                        Date = this.MenuDate.Date
                    };

                await this.mealOrderService.CreateMealOrderAsync(mealOrderIM);
            }
        }

        await BlazoredModal.CloseAsync();
    }

    private async Task UpdateOrder()
    {
        if (FreeConsumptionMeals.Select(fc => fc.IsChecked).All(el => (el == false)) && !MenuOneCheckboxValue && !MenuTwoCheckboxValue)
        {
            return;
        }

        foreach (var meal in FreeConsumptionMeals)
        {
            if (meal.IsChecked && meal.Quantity <= 0)
            {
                return;
            }
        }

        if (MenuOneCheckboxValue && MenuOneQuantity <= 0)
        {
            return;
        }

        if (MenuTwoCheckboxValue && MenuTwoQuantity <= 0)
        {
            return;
        }
            
        if (MenuOneCheckboxValue)                  
        {   
            var menuOrderId = this.MenuOrders.Where(mo => mo.Menu.Id == dailyOrder.MenuTwo.Id).FirstOrDefault()!.Id;

            var menuOrderIM = new MenuOrderIM()
            {                    
                MenuId = dailyOrder.MenuOne.Id,              
                Quantity = MenuOneQuantity,
                Date = this.MenuDate.Date
            };

            await this.menuOrderService.EditMenuOrderAsync(menuOrderId, menuOrderIM);
        }

        if (MenuTwoCheckboxValue)
        {
            var menuOrderId = this.MenuOrders.Where(mo => mo.Menu.Id == dailyOrder.MenuTwo.Id).FirstOrDefault()!.Id;

            var menuTwoIm = new MenuOrderIM()
                {
                MenuId = dailyOrder.MenuTwo.Id,
                Quantity = MenuTwoQuantity,
                Date = this.MenuDate.Date
            };

            await this.menuOrderService.EditMenuOrderAsync(menuOrderId, menuTwoIm);
        }

        foreach (var meals in FreeConsumptionMeals)
        {
            
            if (meals.IsChecked)
            {
                var id = this.MealOrders.Where(mo => mo.Meal.Id == meals.Id).FirstOrDefault()!.Id;

                var mealOrderIM = new MealOrderIM()
                    {
                        MealId = meals.Id,
                        Quantity = meals.Quantity,
                        Date = this.MenuDate.Date
                    };

                await this.mealOrderService.EditMealOrderAsync(id, mealOrderIM);
            }
        }

        await BlazoredModal.CloseAsync();
    }


    /// <summary>
    /// Closes the modal window
    /// </summary>
    private async void CloseModal()
    {
        await BlazoredModal.CancelAsync();
    }

}